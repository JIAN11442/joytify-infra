version: "3"

# Include layer-specific taskfiles
includes:
  compute: ./environments/prod/compute/Taskfile.yaml
  networking: ./environments/prod/networking/Taskfile.yaml
  platform: ./environments/prod/platform/Taskfile.yaml
  security: ./environments/prod/security/Taskfile.yaml

tasks:
  # =============================================================================
  # MAIN OPERATIONS (Primary tasks for daily use)
  # =============================================================================

  all:plan:
    desc: "ðŸ“‹ Plan all infrastructure changes"
    cmds:
      - task: compute:cluster:plan
      - task: platform:config:plan
      - task: networking:ingress:controller:plan
      - task: networking:dns:plan
      - task: security:credentials:plan
      - task: security:certificates:manager:plan
      - task: security:certificates:issuers:plan
      - task: security:certificates:restore:plan
      - task: platform:secrets:plan
      - task: platform:argocd:service:plan
      - task: platform:argocd:ingress:plan
      - task: platform:argocd:applications:plan
      - task: security:certificates:backup:plan
    summary: |
      Shows planned changes for all infrastructure layers.

  all:validate:
    desc: "âœ… Validate all infrastructure configurations"
    cmds:
      - task: compute:cluster:validate
      - task: platform:config:validate
      - task: networking:ingress:controller:validate
      - task: networking:dns:validate
      - task: security:credentials:validate
      - task: security:certificates:manager:validate
      - task: security:certificates:issuers:validate
      - task: security:certificates:restore:validate
      - task: platform:secrets:validate
      - task: platform:argocd:service:validate
      - task: platform:argocd:ingress:validate
      - task: platform:argocd:applications:validate
      - task: security:certificates:backup:validate
    summary: |
      Validates all infrastructure layer configurations.

  all:deploy:
    desc: "ðŸš€ Deploy entire infrastructure stack"
    cmds:
      - task: compute:cluster:deploy
      - task: kubeconfig
      - task: platform:config:deploy
      - task: networking:ingress:controller:deploy
      - task: networking:dns:deploy
      - task: security:credentials:deploy
      - task: security:certificates:manager:deploy
      - task: security:certificates:issuers:deploy
      - task: platform:secrets:deploy
      - task: platform:argocd:service:deploy
      - task: security:certificates:restore:deploy
      - task: platform:argocd:ingress:deploy
      - echo "â³ Waiting 60s for ArgoCD TLS certificate..."
      - sleep 60
      - echo "âœ… Continue deployment"
      - task: platform:argocd:applications:deploy
      - echo "â³ Waiting 60s for API/Web TLS certificates..."
      - sleep 60
      - echo "ðŸ’¾ Backing up all TLS certificates..."
      - task: security:certificates:backup:deploy
      - echo "âœ… Joytify deployment complete!"

    summary: |
      Deploys the complete infrastructure stack in the correct order:
      1. Bootstrap Kubernetes cluster
      2. Kubeconfig setup
      3. Deploy platform configuration
      4. Deploy ingress controller
      5. Deploy DNS
      6. Deploy security credentials
      7. Deploy security certificates manager
      8. Deploy security certificates issuers
      9. Deploy external secrets
      10. Deploy ArgoCD service
      11. Restore TLS certificates from backup
      12. Deploy ArgoCD ingress
      13. Wait for ArgoCD certificate (60s)
      14. Deploy ArgoCD applications
      15. Wait for API/Web certificates (60s)
      16. Backup all TLS certificates to AWS Secrets Manager

  all:destroy:
    desc: "ðŸ’¥ Destroy entire infrastructure stack"
    cmds:
      - task: platform:argocd:applications:destroy
      - task: platform:argocd:ingress:destroy
      - task: security:certificates:backup:destroy
      - task: security:certificates:restore:destroy
      - task: platform:argocd:service:destroy
      - task: platform:secrets:destroy
      - task: security:certificates:issuers:destroy
      - task: security:certificates:manager:destroy
      - task: security:credentials:destroy
      - task: networking:dns:destroy
      - task: networking:ingress:controller:destroy
      - task: platform:config:destroy
      - task: cleanup-kubeconfig
      - task: compute:cluster:destroy
      - task: cleanup-state
    summary: |
      Destroys the complete infrastructure stack in reverse order:
      1. Destroy ArgoCD applications
      2. Destroy ArgoCD ingress
      3. Destroy certificate backup
      4. Destroy certificate restore
      5. Destroy ArgoCD service
      6. Destroy external secrets
      7. Destroy security certificates issuers
      8. Destroy security certificates manager
      9. Destroy security credentials
      10. Destroy DNS
      11. Destroy Ingress controller
      12. Destroy platform configuration
      13. Cleanup kubeconfig
      14. Destroy Kubernetes cluster
      15. Clean up Terraform backend resources

  all:output:
    desc: "ðŸ“¤ Show all infrastructure outputs"
    cmds:
      - task: compute:cluster:output
      - task: platform:config:output
      - task: networking:ingress:controller:output
      - task: networking:dns:output
      - task: security:credentials:output
      - task: security:certificates:manager:output
      - task: security:certificates:issuers:output
      - task: security:certificates:restore:output
      - task: security:certificates:backup:output
      - task: platform:secrets:output
      - task: platform:argocd:applications:output
      - task: platform:argocd:ingress:output
      - task: platform:argocd:service:output
    summary: |
      Displays all outputs from all infrastructure layers.

  # =============================================================================
  # CLUSTER MANAGEMENT (Kubernetes cluster access and maintenance)
  # =============================================================================

  kubeconfig:
    desc: "âš™ï¸ Setup kubeconfig for cluster access"
    dir: "{{.TASKFILE_DIR}}/environments/prod/compute/cluster"
    cmds:
      - |
        echo "âœ… Changed directory to: $(pwd)"

        # æª¢æŸ¥ bootstrap æ˜¯å¦å·²ç¶“æˆåŠŸéƒ¨ç½²
        if ! terragrunt output kubeconfig_raw >/dev/null 2>&1; then
          echo "âŒ Bootstrap not deployed yet or failed. Skipping kubeconfig setup."
          exit 0
        fi

        mkdir -p tmp
        terragrunt output -raw kubeconfig_raw | tr -d '\r' > tmp/doks-kubeconfig.yaml
        echo "âœ… Created kubeconfig file"

        cp ~/.kube/config ~/.kube/config.backup 2>/dev/null || mkdir -p ~/.kube
        echo "âœ… Backed up existing config"

        export KUBECONFIG=$(pwd)/tmp/doks-kubeconfig.yaml:$HOME/.kube/config
        kubectl config view --flatten > ~/.kube/config.new
        mv ~/.kube/config.new ~/.kube/config
        echo "âœ… Merged kubeconfig to ~/.kube/config"

        kubectl get nodes
    summary: |
      Sets up kubeconfig for accessing the Kubernetes cluster.

  cleanup-kubeconfig:
    desc: "âš™ï¸ Cleanup kubeconfig and temporary files"
    dir: "{{.TASKFILE_DIR}}/environments/prod/compute/cluster"
    cmds:
      - |
        echo "âœ… Changed directory to: $(pwd)"

        # å˜—è©¦ç²å– context nameï¼Œå¦‚æžœå¤±æ•—å‰‡è·³éŽ
        CONTEXT_NAME=$(terragrunt output -raw cluster_context_name 2>/dev/null || echo "")

        if [ -n "$CONTEXT_NAME" ]; then
          echo "âœ… Got context name: $CONTEXT_NAME"
          kubectl config delete-context $CONTEXT_NAME 2>/dev/null || true
          kubectl config delete-cluster $CONTEXT_NAME 2>/dev/null || true
          kubectl config unset users.${CONTEXT_NAME}-admin 2>/dev/null || true
          echo "âœ… Removed context: $CONTEXT_NAME"
        else
          echo "âš ï¸  Could not get context name, skipping kubectl cleanup"
        fi

        # æ¢å¾©å‚™ä»½çš„ kubeconfigï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        if [ -f ~/.kube/config.backup ]; then
          mv ~/.kube/config.backup ~/.kube/config
          echo "âœ… Restored ~/.kube/config"
        else
          echo "âš ï¸  No kubeconfig backup found, skipping restore"
        fi

        # æ¸…ç†è‡¨æ™‚æ–‡ä»¶
        rm -rf tmp
        echo "âœ… Removed tmp directory"
    summary: |
      Cleans up kubeconfig and removes temporary files after infrastructure destruction.

  # =============================================================================
  # BACKEND RESOURCE MANAGEMENT
  # =============================================================================

  cleanup-state:
    desc: "ðŸ—„ï¸ Clean up Terraform state resources (S3 bucket and DynamoDB table)"
    cmds:
      - |
        echo "ðŸ§¹ Cleaning up Terraform backend resources..."
        echo ""

        # æª¢æŸ¥ä¸¦åˆªé™¤ S3 bucket
        BUCKET_NAME="joytify-tfstate-bucket"
        echo "ðŸ“¦ Checking S3 bucket: $BUCKET_NAME"
        if aws s3 ls "s3://$BUCKET_NAME" 2>/dev/null; then
          echo "ðŸ—‘ï¸  Deleting S3 bucket: $BUCKET_NAME"
          
          # æª¢æŸ¥ç‰ˆæœ¬æŽ§åˆ¶ç‹€æ…‹
          VERSIONING=$(aws s3api get-bucket-versioning --bucket "$BUCKET_NAME" --query 'Status' --output text 2>/dev/null || echo "Disabled")
          if [ "$VERSIONING" = "Enabled" ]; then
            echo "âš ï¸  Bucket has versioning enabled, suspending versioning first..."
            aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" --versioning-configuration Status=Suspended 2>/dev/null
            sleep 2
          fi
          
          # åˆªé™¤æ‰€æœ‰ç‰ˆæœ¬å’Œåˆªé™¤æ¨™è¨˜
          echo "ðŸ—‘ï¸  Removing all object versions and delete markers..."
          aws s3api delete-objects --bucket "$BUCKET_NAME" --delete "$(aws s3api list-object-versions --bucket "$BUCKET_NAME" --output json --query '{Objects: Versions[].{Key:Key,VersionId:VersionId}}')" 2>/dev/null || true
          aws s3api delete-objects --bucket "$BUCKET_NAME" --delete "$(aws s3api list-object-versions --bucket "$BUCKET_NAME" --output json --query '{Objects: DeleteMarkers[].{Key:Key,VersionId:VersionId}}')" 2>/dev/null || true
          
          # ç¾åœ¨å˜—è©¦åˆªé™¤ bucket
          aws s3 rb "s3://$BUCKET_NAME" --force 2>/dev/null && echo "âœ… S3 bucket deleted successfully" || echo "âš ï¸  Failed to delete S3 bucket"
        else
          echo "âœ… S3 bucket $BUCKET_NAME not found or already deleted"
        fi

        echo ""

        # æª¢æŸ¥ä¸¦åˆªé™¤ DynamoDB table
        TABLE_NAME="joytify-tfstate-lock-table"
        echo "ðŸ—„ï¸  Checking DynamoDB table: $TABLE_NAME"
        if aws dynamodb describe-table --table-name "$TABLE_NAME" --region ap-northeast-1 2>/dev/null; then
          echo "ðŸ—‘ï¸  Deleting DynamoDB table: $TABLE_NAME"
          aws dynamodb delete-table --table-name "$TABLE_NAME" --region ap-northeast-1 2>/dev/null && echo "âœ… DynamoDB table deleted successfully" || echo "âš ï¸  Failed to delete DynamoDB table"
        else
          echo "âœ… DynamoDB table $TABLE_NAME not found or already deleted"
        fi

        echo ""

        # æ¸…ç† Terraform å’Œ Terragrunt ç·©å­˜
        echo "ðŸ§¹ Cleaning up Terraform and Terragrunt cache..."
        find . -name ".terragrunt-cache" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name ".terraform" -type d -exec rm -rf {} + 2>/dev/null || true
        echo "âœ… Cache cleanup completed"

        echo ""
        echo "ðŸŽ‰ Backend cleanup completed"
    summary: |
      Manually cleans up Terraform backend resources (S3 bucket, DynamoDB table) and local cache

  # =============================================================================
  # OTHER
  # =============================================================================

  status:
    desc: "ðŸ“Š Check infrastructure status"
    cmds:
      - |
        echo "ðŸ” Checking infrastructure status..."
        echo ""
        echo "ðŸ–¥ï¸ Compute Layer:"
        cd environments/prod/compute && terragrunt run-all output 2>/dev/null || echo "  Not deployed"
        echo ""
        echo "ðŸŒ Networking Layer:"
        cd ../networking && terragrunt run-all output 2>/dev/null || echo "  Not deployed"
        echo ""
        echo "ðŸ”§ Platform Layer:"
        cd ../platform && terragrunt run-all output 2>/dev/null || echo "  Not deployed"
        echo ""
        echo "ðŸ”’ Security Layer:"
        cd ../security && terragrunt run-all output 2>/dev/null || echo "  Not deployed"
    summary: |
      Shows the current status of all infrastructure layers.

  help:
    desc: "ðŸ“š Show available tasks and their descriptions"
    cmds:
      - task --list
    summary: |
      Lists all available tasks with descriptions.
